// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

enum FileFormat {
  IMAGE
  PDF
  VIDEO
  AUDIO
  OTHER
}

enum MediaType {
  PFP
  THUMBNAIL
  MAIN
  GALLERY
  BANNER
  FLOORPLAN
  DOCUMENT
  PAYMENT
  QR
  MAP
  ROOM
  VALID_ID
}

enum ImageQuality {
  LOW
  MEDIUM
  HIGH
}

enum BookingStatus {
  PENDING_REQUEST //üü° Tenant requested booking
  AWAITING_PAYMENT //üü† Owner approved, waiting for tenant to upload proof
  PAYMENT_APPROVAL //üü†
  CANCELLED_BOOKING //üî¥
  REJECTED_BOOKING //üî¥
  COMPLETED_BOOKING //üü¢
  PAYMENT_FAILED
}

enum BookingType {
  RESERVATION // owner-approved reservation (awaiting payment)
  INSTANT // auto-confirmed (instant booking)
  HOLD // short hold (non-committal)
  LONG_TERM // monthly leases
  SHORT_TERM // days/weeks
}

enum PaymentProvider {
  PAYMONGO
}

enum PaymentStatus {
  PENDING
  REQUIRES_ACTION
  PAID
  FAILED
  CANCELLED
  REFUNDED
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  CANCELLED
  EXPIRED
  PAST_DUE
}

enum PurchaseType {
  ROOM_BOOKING
  SUBSCRIPTION
  DEPOSIT
}

enum PayoutStatus {
  PENDING
  PAID_OUT
  FAILED
}

enum PayoutType {
  GCASH
}

enum CurrencyType {
  PHP // Philippine peso
  USD // U.S dollar
  EUR // euro
  JPY //japanese
}

enum UserRole {
  TENANT
  OWNER
  ADMIN
}

enum ResourceType {
  TENANT
  OWNER
  ADMIN
  BOARDING_HOUSE
  ROOM
  BOOKING
  SUBSCRIPTION
}

enum RoomType {
  STUDIO
  SINGLE
  DOUBLE
  BED_SPACER
  APARTMENT
}

enum RoomFurnishingEnumSchema {
  UNFURNISHED
  SEMI_FURNISHED
  FULLY_FURNISHED
}

enum OccupancyType {
  MALE
  FEMALE
  MIXED
}

enum VerificationType {
  BIR
  DTI // sole proprietors, Optional Extension
  SEC // sole corporation/partnerships, Optional Extension
  FIRE_CERTIFICATE // Fire Certificate
  SANITARY_PERMIT
  // BUSINESS_PERMIT // Base for DTI and SEC
  // MAYORS_PERMIT // Mayor's Permit
  VALID_ID
}

enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  VERIFY
}

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
  // output   = "../generated/prisma" // need more research on this
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id                           Int                    @id @default(autoincrement())
  username                     String                 @unique
  firstname                    String?
  lastname                     String?
  email                        String                 @unique
  password                     String
  role                         UserRole               @default(TENANT) // changed
  hasAcceptedLegitimacyConsent Boolean                @default(false)
  consentAcceptedAt            DateTime?
  isActive                     Boolean                @default(true)
  isVerified                   Boolean                @default(false)
  createdAt                    DateTime               @default(now())
  updatedAt                    DateTime               @updatedAt
  age                          Int?                   @default(0)
  guardian                     String?
  address                      String?
  phone_number                 String?
  isDeleted                    Boolean                @default(false)
  deletedAt                    DateTime?
  bookings                     Booking[]
  verificationDocuments        VerificationDocument[]
  reviews                      Review[]
}

model Owner {
  id                           Int                    @id @default(autoincrement())
  username                     String                 @unique
  firstname                    String?
  lastname                     String?
  email                        String                 @unique
  password                     String
  role                         UserRole               @default(OWNER)
  hasAcceptedLegitimacyConsent Boolean                @default(false)
  consentAcceptedAt            DateTime?
  isActive                     Boolean                @default(true)
  isVerified                   Boolean                @default(false)
  createdAt                    DateTime               @default(now())
  updatedAt                    DateTime               @updatedAt
  age                          Int?                   @default(0)
  address                      String?
  phone_number                 String?
  boardingHouses               BoardingHouse[]
  isDeleted                    Boolean                @default(false)
  deletedAt                    DateTime?
  verificationDocuments        VerificationDocument[] // permit relation
}

model OwnerPayoutMethod {
  id      Int @id @default(autoincrement())
  ownerId Int @unique

  type          PayoutType @default(GCASH)
  accountName   String
  accountNumber String

  isVerified Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Admin {
  id                    Int                    @id @default(autoincrement())
  username              String                 @unique
  firstname             String
  lastname              String
  email                 String                 @unique
  password              String
  role                  UserRole               @default(ADMIN)
  isActive              Boolean                @default(true)
  isVerified            Boolean                @default(false)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  age                   Int                    @default(0)
  address               String
  phone_number          String
  isDeleted             Boolean                @default(false)
  deletedAt             DateTime?
  verificationDocuments VerificationDocument[]
}

model BoardingHouse {
  id                 Int           @id @default(autoincrement())
  ownerId            Int
  owner              Owner         @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  name               String
  address            String?
  description        String?
  amenities          Json?
  availabilityStatus Boolean       @default(false)
  occupancyType      OccupancyType @default(MIXED)
  locationId         Int           @unique
  location           Location      @relation(fields: [locationId], references: [id], name: "BoardingHouseToLocation")
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  isDeleted          Boolean       @default(false)
  deletedAt          DateTime?
  rooms              Room[]
  Booking            Booking[]
  reviews            Review[]
}

model Review {
  id              Int           @id @default(autoincrement())
  tenantId        Int
  boardingHouseId Int
  tenant          Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  boardingHouse   BoardingHouse @relation(fields: [boardingHouseId], references: [id], onDelete: Cascade)
  rating          Int
  comment         String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  isDeleted       Boolean       @default(false)
  deletedAt       DateTime?
}

model Location {
  id            Int                     @id @default(autoincrement())
  coordinates   Unsupported("geometry")
  city          String?
  province      String?
  country       String?
  boardingHouse BoardingHouse?          @relation(name: "BoardingHouseToLocation")
  isDeleted     Boolean                 @default(false)
  deletedAt     DateTime?
}

model Booking {
  id              Int           @id @default(autoincrement())
  reference       String        @unique // e.g. BK-20251023-XXXX
  tenantId        Int
  tenant          Tenant        @relation(fields: [tenantId], references: [id], onDelete: Restrict)
  roomId          Int
  room            Room          @relation(fields: [roomId], references: [id])
  boardingHouseId Int
  boardingHouse   BoardingHouse @relation(fields: [boardingHouseId], references: [id])
  bookingType     BookingType   @default(RESERVATION)
  dateBooked      DateTime
  checkInDate     DateTime
  checkOutDate    DateTime
  status          BookingStatus @default(PENDING_REQUEST)
  paymentProofId  Int? // uploaded receipt / image URL
  totalAmount     Decimal?      @db.Decimal(10, 2)
  currency        CurrencyType  @default(PHP)
  ownerMessage    String?
  tenantMessage   String?
  expiresAt       DateTime? // e.g. if pending payment, expiry to auto-cancel
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  isDeleted       Boolean       @default(false)
  deletedAt       DateTime?
  payments        Payment[]
  paymentId       Int?
}

model Payment {
  id Int @id @default(autoincrement())

  provider PaymentProvider @default(PAYMONGO)

  // External references (PayMongo)
  providerPaymentId String? @unique
  providerIntentId  String?
  providerSourceId  String?

  amount   Decimal      @db.Decimal(10, 2)
  currency CurrencyType @default(PHP)

  status       PaymentStatus @default(PENDING)
  purchaseType PurchaseType

  userId   Int
  userType ResourceType

  ownerId Int

  bookingId Int?
  booking   Booking? @relation(fields: [bookingId], references: [id])

  subscriptionId Int?
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id])

  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  payouts   Payout[]
}

model Payout {
  id      Int @id @default(autoincrement())
  ownerId Int

  amount   Decimal
  currency CurrencyType @default(PHP)

  status PayoutStatus @default(PENDING)

  paymentId Int
  payment   Payment @relation(fields: [paymentId], references: [id])

  createdAt DateTime  @default(now())
  paidAt    DateTime?
}

model Subscription {
  id Int @id @default(autoincrement())

  userId   Int
  userType ResourceType

  provider               PaymentProvider @default(PAYMONGO)
  providerSubscriptionId String          @unique

  status SubscriptionStatus @default(INACTIVE)

  currentPeriodStart DateTime
  currentPeriodEnd   DateTime

  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  payments Payment[]
}

model Room {
  id                  Int                      @id @default(autoincrement())
  boardingHouseId     Int
  boardingHouse       BoardingHouse            @relation(fields: [boardingHouseId], references: [id], onDelete: Cascade)
  roomNumber          String
  description         String
  maxCapacity         Int                      @default(1)
  currentCapacity     Int                      @default(0)
  price               Decimal                  @db.Decimal(10, 2)
  roomType            RoomType                 @default(SINGLE)
  furnishingType      RoomFurnishingEnumSchema @default(UNFURNISHED)
  tags                Json?
  availabilityStatus  Boolean                  @default(true)
  createdAt           DateTime                 @default(now())
  updatedAt           DateTime                 @updatedAt
  isDeleted           Boolean                  @default(false)
  deletedAt           DateTime?
  bookings            Booking[]
  roomAvailabilityLog RoomAvailabilityLog[]
}

model RoomAvailabilityLog {
  id        Int      @id @default(autoincrement())
  roomId    Int
  room      Room     @relation(fields: [roomId], references: [id])
  status    Boolean // true = available, false = locked/unavailable
  reason    String?
  createdAt DateTime @default(now())
}

model VerificationDocument {
  id                 Int                @id @default(autoincrement())
  userType           UserRole // TENANT or OWNER
  userId             Int // points to either Tenant.id or Owner.id
  fileFormat         FileFormat         @default(PDF)
  verificationType   VerificationType
  url                String
  expiresAt          DateTime
  verificationStatus VerificationStatus @default(PENDING)
  verifiedById       Int?
  verifiedBy         Admin?             @relation(fields: [verifiedById], references: [id])
  verifiedAt         DateTime?
  rejectionReason    String?
  approvedAt         DateTime?
  uploadedAt         DateTime           @default(now())
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  isDeleted          Boolean            @default(false)
  deletedAt          DateTime?
  tenant             Tenant?            @relation(fields: [tenantId], references: [id])
  tenantId           Int?
  owner              Owner?             @relation(fields: [ownerId], references: [id])
  ownerId            Int?
}

model Image {
  id         Int          @id @default(autoincrement())
  url        String
  fileFormat FileFormat   @default(IMAGE)
  type       MediaType
  quality    ImageQuality @default(MEDIUM)
  createdAt  DateTime     @default(now())
  isDeleted  Boolean      @default(false) // For soft deletion
  deletedAt  DateTime?

  // Polymorphic references
  entityType ResourceType
  entityId   Int
}

model AuditLog {
  id        Int         @id @default(autoincrement())
  userId    Int?
  user      Json
  action    AuditAction // e.g. "CREATE", "UPDATE", "DELETE", "LOGIN", etc.
  tableName String // e.g. "Tenant", "Booking"
  recordId  Int? // The ID of the record affected, nullable in case not applicable
  meta      Json? // Optional: store extra info (diff, payload, IP, etc.)
  createdAt DateTime    @default(now())
  isDeleted Boolean     @default(false)
  deletedAt DateTime?
  ipAddress String?
  userAgent String?
}

enum NotificationType {
  // Booking
  BOOKING_REQUESTED
  BOOKING_APPROVED
  BOOKING_REJECTED
  PAYMENT_UPLOADED
  PAYMENT_APPROVED
  BOOKING_CANCELLED
  BOOKING_COMPLETED

  // Verification
  VERIFICATION_APPROVED
  VERIFICATION_REJECTED

  // Property updates
  BOARDING_HOUSE_UPDATED
  BOARDING_AVAILABILITY_CHANGED
  ROOM_UPDATED
  ROOM_AVAILABILITY_CHANGED

  // System
  SYSTEM
}

enum NotificationChannel {
  IN_APP
  EMAIL
  PUSH
}

model Notification {
  id            Int              @id @default(autoincrement())
  recipientRole UserRole
  recipientId   Int
  type          NotificationType
  title         String
  message       String
  entityType    ResourceType
  entityId      Int

  // Optional metadata (deep links, extra payload)
  data Json?

  channel   NotificationChannel @default(IN_APP)
  isRead    Boolean             @default(false)
  readAt    DateTime?
  createdAt DateTime            @default(now())
  expiresAt DateTime?
  isDeleted Boolean             @default(false)
}

//* do this to change Json to JSONB
/**
 * ALTER TABLE "BoardingHouse"
 * ALTER COLUMN "amenities" TYPE jsonb USING "amenities"::jsonb;
 * ALTER TABLE "BoardingHouse"
 * ALTER COLUMN "properties" TYPE jsonb USING "properties"::jsonb;
 * ALTER TABLE "Room"
 * ALTER COLUMN "features" TYPE jsonb USING "features"::jsonb;
 * ALTER TABLE "Room"
 * ALTER COLUMN "tags" TYPE jsonb USING "tags"::jsonb;
 * ALTER TABLE "AuditLog"
 * ALTER COLUMN "meta" TYPE jsonb USING "meta"::jsonb;
 * ALTER TABLE "AuditLog"
 * ALTER COLUMN "user" TYPE jsonb USING "user"::jsonb;
 * -- üßº Update NULLs to default values
 * UPDATE "BoardingHouse"
 * SET "amenities" = '[]'::jsonb
 * WHERE "amenities" IS NULL;
 * UPDATE "BoardingHouse"
 * UPDATE "Room"
 * SET "features" = '{}'::jsonb
 * WHERE "features" IS NULL;
 * UPDATE "Room"
 * SET "tags" = '[]'::jsonb
 * WHERE "tags" IS NULL;
 * UPDATE "AuditLog"
 * SET "meta" = '{}'::jsonb
 * WHERE "meta" IS NULL;
 * UPDATE "AuditLog"
 * SET "user" = '{}'::jsonb
 * WHERE "user" IS NULL;
 * -- ‚ö° Add GIN indexes for JSONB fields
 * CREATE INDEX gin_idx_boardinghouse_amenities ON "BoardingHouse" USING GIN ("amenities");
 * CREATE INDEX gin_idx_room_features ON "Room" USING GIN ("features");
 * CREATE INDEX gin_idx_room_tags ON "Room" USING GIN ("tags");
 * CREATE INDEX gin_idx_auditlog_meta ON "AuditLog" USING GIN ("meta");
 * CREATE INDEX gin_idx_auditlog_user ON "AuditLog" USING GIN ("user");
 * -- add constraints for images, ‚ùó Reserved for future schema integrity
 * ALTER TABLE "Image" ADD CONSTRAINT check_one_relation CHECK ("boardingHouseId" IS NOT NULL OR "roomId" IS NOT NULL OR "ownerId" IS NOT NULL OR "tenantId" IS NOT NULL OR "adminId" IS NOT NULL);
 */

//* for older data
// UPDATE "BoardingHouse"
// SET "amenities" = '[]'::jsonb
// WHERE "amenities" IS NULL;

//* do this to activate PostGis every after pushing rest
// CREATE EXTENSION postgis;
